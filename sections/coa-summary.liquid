{% comment %}
  COA Summary
  Displays cannabinoid table, test date, lab name, batch ID, and link to full COA.
  Merchants set the product handle in settings.
{% endcomment %}

{% assign product = all_products[section.settings.product_handle] %}

{% if product %}
  <section class="coa-summary">
    <div class="coa-summary__inner">
      <h1 class="coa-summary__title">{{ product.title }} COA</h1>
      {% if product.metafields.custom.batch_id != blank %}
        <p><strong>Batch ID:</strong> {{ product.metafields.custom.batch_id.value }}</p>
      {% endif %}
      {% if product.metafields.custom.tested_at != blank %}
        <p><strong>Tested at:</strong> {{ product.metafields.custom.tested_at.value | date: "%B %-d, %Y" }}</p>
      {% endif %}
      {% if product.metafields.custom.lab_name != blank %}
        <p><strong>Lab:</strong> {{ product.metafields.custom.lab_name.value }}</p>
      {% endif %}
      {% assign cannabinoid_data = product.metafields.custom.cannabinoids_json.value %}
      {% if cannabinoid_data != blank %}
        <table class="coa-summary__table">
          <thead>
            <tr><th>Cannabinoid</th><th>Amount</th></tr>
          </thead>
          <tbody>
            {% for entry in cannabinoid_data %}
              {% assign cannabinoid_name = entry[0] | default: entry.name | default: entry.key %}
              {% assign cannabinoid_amount = entry[1] | default: entry.value %}
              <tr>
                <td>{{ cannabinoid_name }}</td>
                <td>{{ cannabinoid_amount }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
      {% if product.metafields.custom.coa_url != blank %}
        <p><a href="{{ product.metafields.custom.coa_url.value }}" class="coa-summary__button" target="_blank" rel="noopener">View full COA</a></p>
      {% endif %}
    </div>
  </section>

  <style>
    .coa-summary { margin: 2rem 0; }
    .coa-summary__inner { background:#fff; border-radius:0.75rem; padding:1.5rem; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .coa-summary__title { font-size:1.5rem; margin-bottom:1rem; }
    .coa-summary__table { width:100%; border-collapse:collapse; margin-top:1rem; }
    .coa-summary__table th,.coa-summary__table td { padding:0.5rem; border-bottom:1px solid #eee; text-align:left; }
    .coa-summary__button { display:inline-block; margin-top:1rem; padding:0.75rem 1.25rem; background:#0070f3; color:#fff; border-radius:0.5rem; text-decoration:none; }
    .coa-summary__button:focus { outline:2px solid #0053a3; }
  </style>
{% else %}
  <p>No product found. Please set the product handle in the section settings.</p>
{% endif %}

{% schema %}
{
  "name": "COA summary",
  "settings": [
    {
      "type": "text",
      "id": "product_handle",
      "label": "Product handle",
      "info": "Enter the handle of the product this COA is for (e.g., whispering-roots-2g-disposable)"
    }
  ],
  "presets": [
    { "name": "COA summary" }
  ]
}
{% endschema %}
